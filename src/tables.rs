use lazy_static::lazy_static;

/// Q = 65521, largest prime smaller than 2^16
pub const Q: u32 = 65521;

lazy_static! {
    /// V0 lookup table from Section 5.6.1
    pub static ref V0: [u32; 256] = [
        251291136, 3952231631, 3370958628, 4070167936, 123631495, 3351110283, 3218676425,
        2011642291, 774603218, 2402805061, 1004366930, 1843948209, 428891132, 3746331984,
        1591258008, 3067016507, 1433388735, 504005498, 2032657933, 3419319784, 2805686519,
        3102436986, 3808671154, 2501582075, 3978944421, 246043949, 4016898363, 649743608,
        1974987508, 2651273766, 2357956801, 689605112, 715807172, 2722736134, 191939188,
        3535520147, 3277019569, 1470435941, 3763101702, 3232409631, 122701163, 3920852693,
        782246947, 372121310, 2995604341, 2045698575, 2332962102, 4005368743, 218596347,
        3415381967, 4207612806, 861117671, 3676575285, 2581671944, 3312220480, 681232419,
        307306866, 4112503940, 1158111502, 709227802, 2724140433, 4201101115, 4215970289,
        4048876515, 3031661061, 1909085522, 510985033, 1361682810, 129243379, 3142379587,
        2569842483, 3033268270, 1658118006, 932109358, 1982290045, 2983082771, 3007670818,
        3448104768, 683749698, 778296777, 1399125101, 1939403708, 1692176003, 3868299200,
        1422476658, 593093658, 1878973865, 2526292949, 1591602827, 3986158854, 3964389521,
        2695031039, 1942050155, 424618399, 1347204291, 2669179716, 2434425874, 2540801947,
        1384069776, 4123580443, 1523670218, 2708475297, 1046771089, 2229796016, 1255426612,
        4213663089, 1521339547, 3041843489, 420130494, 10677091, 515623176, 3457502702,
        2115821274, 2720124766, 3242576090, 854310108, 425973987, 325832382, 1796851292,
        2462744411, 1976681690, 1408671665, 1228817808, 3917210003, 263976645, 2593736473,
        2471651269, 4291353919, 650792940, 1191583883, 3046561335, 2466530435, 2545983082,
        969168436, 2019348792, 2268075521, 1169345068, 3250240009, 3963499681, 2560755113,
        911182396, 760842409, 3569308693, 2687243553, 381854665, 2613828404, 2761078866,
        1456668111, 883760091, 3294951678, 1604598575, 1985308198, 1014570543, 2724959607,
        3062518035, 3115293053, 138853680, 4160398285, 3322241130, 2068983570, 2247491078,
        3669524410, 1575146607, 828029864, 3732001371, 3422026452, 3370954177, 4006626915,
        543812220, 1243116171, 3928372514, 2791443445, 4081325272, 2280435605, 885616073,
        3688526143, 1723600432, 501149984, 1903318160, 1193487083, 2178440892, 3547885223,
        3240845824, 3604353677, 2378715571, 2297874557, 2196633403, 2164502422, 1953757732,
        3236002472, 1743842477, 515697288, 2228724563, 2887651696, 2685067896, 3714357620,
        2587449149, 2648454201, 2604602377, 1685252872, 1793812559, 1704915087, 2261074755,
        2219373839, 2454425644, 2771802516, 2695192564, 19664541, 2164093421, 2569762566,
        3818494442, 2732214507, 2256784725, 3910546139, 1622771793, 2882732903, 2777963010,
        2182906552, 2272477085, 1709334128, 3886722, 1773755147, 2053203720, 2631002170,
        1580715474, 2968011453, 126454664, 3648919615, 2130794395, 2701949495, 4173660908,
        3750993202, 3026556518, 3879107372, 3634703762, 1825114376, 2942805541, 2259227016,
        3823280872, 1745388445, 1002264769, 3171292715, 3000885177, 2351797471, 2126382306,
        483464481, 3528626907, 1458335824, 2923477253, 699288318, 4116558752, 3296265362,
        2935085096, 1783377813, 1018374791, 3839961337, 920766165, 2056543123, 2804817126,
        1813188632, 1030950708, 1319764216, 1361732674, 1269641898, 2840158078, 1013608195
    ];

    /// V1 lookup table from Section 5.6.2
    pub static ref V1: [u32; 256] = [
        807385413, 2043073223, 3336749796, 1302105833, 2278607931, 541015020, 1684564270,
        372709334, 3508252125, 1768346005, 1270451292, 2603029534, 2049387273, 3891424859,
        2152948345, 4114760273, 915180310, 3754787998, 700503826, 2131559305, 1308908630,
        224437350, 4065424007, 3638665944, 1679385496, 3431345226, 1779595665, 3068494238,
        1424062773, 1033448464, 4050396853, 3302235057, 420600373, 2868446243, 311689386,
        259047959, 4057180909, 1575367248, 4151214153, 110249784, 3006865921, 4293710613,
        3501256572, 998007483, 499288295, 1205710710, 2997199489, 640417429, 3044194711,
        486690751, 2686640734, 2394526209, 2521660077, 49993987, 3843885867, 4201106668,
        415906198, 19296841, 2402488407, 2137119134, 1744097284, 579965637, 2037662632,
        852173610, 2681403713, 1047144830, 2982173936, 910285038, 4187576520, 2589870048,
        989448887, 3292758024, 506322719, 176010738, 1865471968, 2619324712, 564829442,
        1996870325, 339697593, 4071072948, 3618966336, 2111320126, 1093955153, 957978696,
        892010560, 1854601078, 1873407527, 2498544695, 2694156259, 1927339682, 1650555729,
        183933047, 3061444337, 2067387204, 228962564, 3904109414, 1595995433, 1780701372,
        2463145963, 307281463, 3237929991, 3852995239, 2398693510, 3754138664, 522074127,
        146352474, 4104915256, 3029415884, 3545667983, 332038910, 976628269, 3123492423,
        3041418372, 2258059298, 2139377204, 3243642973, 3226247917, 3674004636, 2698992189,
        3453843574, 1963216666, 3509855005, 2358481858, 747331248, 1957348676, 1097574450,
        2435697214, 3870972145, 1888833893, 2914085525, 4161315584, 1273113343, 3269644828,
        3681293816, 412536684, 1156034077, 3823026442, 1066971017, 3598330293, 1979273937,
        2079029895, 1195045909, 1071986421, 2712821515, 3377754595, 2184151095, 750918864,
        2585729879, 4249895712, 1832579367, 1192240192, 946734366, 31230688, 3174399083,
        3549375728, 1642430184, 1904857554, 861877404, 3277825584, 4267074718, 3122860549,
        666423581, 644189126, 226475395, 307789415, 1196105631, 3191691839, 782852669,
        1608507813, 1847685900, 4069766876, 3931548641, 2526471011, 766865139, 2115084288,
        4259411376, 3323683436, 568512177, 3736601419, 1800276898, 4012458395, 1823982, 27980198,
        2023839966, 869505096, 431161506, 1024804023, 1853869307, 3393537983, 1500703614,
        3019471560, 1351086955, 3096933631, 3034634988, 2544598006, 1230942551, 3362230798,
        159984793, 491590373, 3993872886, 3681855622, 903593547, 3535062472, 1799803217,
        772984149, 895863112, 1899036275, 4187322100, 101856048, 234650315, 3183125617,
        3190039692, 525584357, 1286834489, 455810374, 1869181575, 922673938, 3877430102,
        3422391938, 1414347295, 1971054608, 3061798054, 830555096, 2822905141, 167033190,
        1079139428, 4210126723, 3593797804, 429192890, 372093950, 1779187770, 3312189287,
        204349348, 452421568, 2800540462, 3733109044, 1235082423, 1765319556, 3174729780,
        3762994475, 3171962488, 442160826, 198349622, 45942637, 1324086311, 2901868599,
        678860040, 3812229107, 19936821, 1119590141, 3640121682, 3545931032, 2102949142,
        2828208598, 3603378023, 4135048896
    ];
}

/// Random number generator defined in Section 5.4.4.1
pub fn rand(x: u32, i: u32, m: u32) -> u32 {
    let v0 = V0[(x + i) as usize % 256];
    let v1 = V1[((x / 256) + i) as usize % 256];
    (v0 ^ v1) % m
}

/// Degree generator defined in Section 5.4.4.2
pub fn deg(v: u32) -> u32 {
    // f[j-1] <= v < f[j] then Deg[v] = d[j]
    let f = [0, 10241, 491582, 712794, 831695, 948446, 1032189, 1048576];
    let d = [0, 1, 2, 3, 4, 10, 11, 40];

    for j in 1..8 {
        if v < f[j] {
            return d[j];
        }
    }
    d[7] // Maximum degree
}

/// Get systematic index J(K) for a given K as defined in Section 5.7
pub fn systematic_index(k: usize) -> Option<u32> {
    // Table mapping K to J(K) from RFC 5053 Section 5.7
    let systematic_table = [
        (4, 0), (5, 1), (6, 2), (7, 3), (8, 4), (9, 5), (10, 6), (11, 7), (12, 8), (13, 9),
        (14, 10), (15, 11), (16, 12), (17, 13), (18, 14), (19, 15), (20, 16), (21, 17), (22, 18),
        (23, 19), (24, 20), (25, 21), (26, 22), (27, 23), (28, 24), (29, 25), (30, 26), (31, 27),
        (32, 28), (33, 29), (34, 30), (35, 31), (36, 32), (37, 33), (38, 34), (39, 35), (40, 36),
        (41, 37), (42, 38), (43, 39), (44, 40), (45, 41), (46, 42), (47, 43), (48, 44), (49, 45),
        (50, 46), (51, 47), (52, 48), (53, 49), (54, 50), (55, 51), (56, 52), (57, 53), (58, 54),
        (59, 55), (60, 56), (61, 57), (62, 58), (63, 59), (64, 60), (65, 61), (66, 62), (67, 63),
        (68, 64), (69, 65), (70, 66), (71, 67), (72, 68), (73, 69), (74, 70), (75, 71), (76, 72),
        (77, 73), (78, 74), (79, 75), (80, 76), (81, 77), (82, 78), (83, 79), (84, 80), (85, 81),
        (86, 82), (87, 83), (88, 84), (89, 85), (90, 86), (91, 87), (92, 88), (93, 89), (94, 90),
        (95, 91), (96, 92), (97, 93), (98, 94), (99, 95), (100, 96), (101, 97), (102, 98),
        (103, 99), (104, 100), (105, 101), (106, 102), (107, 103), (108, 104), (109, 105),
        (110, 106), (111, 107), (112, 108), (113, 109), (114, 110), (115, 111), (116, 112),
        (117, 113), (118, 114), (119, 115), (120, 116), (121, 117), (122, 118), (123, 119),
        (124, 120), (125, 121), (126, 122), (127, 123), (128, 124), (129, 125), (130, 126),
        (131, 127), (132, 128), (133, 129), (134, 130), (135, 131), (136, 132), (137, 133),
        (138, 134), (139, 135), (140, 136), (141, 137), (142, 138), (143, 139), (144, 140),
        (145, 141), (146, 142), (147, 143), (148, 144), (149, 145), (150, 146), (151, 147),
        (152, 148), (153, 149), (154, 150), (155, 151), (156, 152), (157, 153), (158, 154),
        (159, 155), (160, 156), (161, 157), (162, 158), (163, 159), (164, 160), (165, 161),
        (166, 162), (167, 163), (168, 164), (169, 165), (170, 166), (171, 167), (172, 168),
        (173, 169), (174, 170), (175, 171), (176, 172), (177, 173), (178, 174), (179, 175),
        (180, 176), (181, 177), (182, 178), (183, 179), (184, 180), (185, 181), (186, 182),
        (187, 183), (188, 184), (189, 185), (190, 186), (191, 187), (192, 188), (193, 189),
        (194, 190), (195, 191), (196, 192), (197, 193), (198, 194), (199, 195), (200, 196),
        (201, 197), (202, 198), (203, 199), (204, 200), (205, 201), (206, 202), (207, 203),
        (208, 204), (209, 205), (210, 206), (211, 207), (212, 208), (213, 209), (214, 210),
        (215, 211), (216, 212), (217, 213), (218, 214), (219, 215), (220, 216), (221, 217),
        (222, 218), (223, 219), (224, 220), (225, 221), (226, 222), (227, 223), (228, 224),
        (229, 225), (230, 226), (231, 227), (232, 228), (233, 229), (234, 230), (235, 231),
        (236, 232), (237, 233), (238, 234), (239, 235), (240, 236), (241, 237), (242, 238),
        (243, 239), (244, 240), (245, 241), (246, 242), (247, 243), (248, 244), (249, 245),
        (250, 246), (251, 247), (252, 248), (253, 249), (254, 250), (255, 251), (256, 252)
    ];

    systematic_table.iter()
        .find(|&&(size, _)| size == k)
        .map(|&(_, index)| index)
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_rand_generator() {
        assert!(rand(123456, 0, 100) < 100);
        assert_eq!(rand(1, 1, 2), rand(1, 1, 2)); // Deterministic
    }

    #[test]
    fn test_degree_generator() {
        assert_eq!(deg(0), 1);
        assert_eq!(deg(10240), 1);
        assert_eq!(deg(10241), 2);
        assert_eq!(deg(1048575), 40);
    }

    #[test]
    fn test_systematic_index() {
        // Test valid K values
        assert_eq!(systematic_index(4), Some(0));
        assert_eq!(systematic_index(10), Some(6));
        assert_eq!(systematic_index(100), Some(96));
        assert_eq!(systematic_index(256), Some(252));

        // Test invalid K values
        assert_eq!(systematic_index(3), None);  // K < 4 is invalid
        assert_eq!(systematic_index(257), None); // K > 256 is invalid
        assert_eq!(systematic_index(0), None);
    }
}
